# lvl3-cloud

Automated deployment of OpenStack (DevStack) with a Kubernetes cluster on top using Terraform and Ansible.

## Quick Start

```bash
curl -L https://raw.githubusercontent.com/4n4k1n/lvl3-cloud/refs/heads/main/scripts/setup.sh | bash
```

## Prerequisites

- Ubuntu/Debian Linux with 8GB+ RAM, 4+ CPU cores
- KVM/Libvirt support

## Project Structure

```
lvl3-cloud/
├── scripts/           # Deployment scripts
├── infra/
│   ├── terraform/k8s/ # Infrastructure provisioning
│   └── ansible/       # Cluster configuration
└── local.conf.template
```

## Scripts

| Script | Purpose |
|--------|---------|
| `setup.sh` | Main entry point - deploys entire stack (DevStack + K8s) |
| `cluster.sh` | Runs Terraform and Ansible to provision K8s cluster |
| `create_k8s_flavor.sh` | Creates OpenStack VM flavors for K8s nodes |
| `create_ubuntu_image.sh` | Downloads and registers Ubuntu 22.04 in Glance |
| `create_demo_vm.sh` | Spins up a test VM to verify OpenStack works |
| `remove_demo_vm.sh` | Cleans up the demo VM |

## Terraform

Provisions the infrastructure on OpenStack for the Kubernetes cluster.

| Resource | Description |
|----------|-------------|
| Flavors | Control plane (2 vCPU, 6GB RAM), Worker (1 vCPU, 4GB RAM) |
| Image | Ubuntu 22.04 cloud image |
| Keypair | Auto-generated RSA 4096-bit SSH key |
| Network | Private network (192.168.100.0/24) with router to external |
| Security Groups | SSH, ICMP, and internal cluster traffic |
| Floating IPs | Public IPs for external access to VMs |
| Instances | 1 control plane + N worker nodes |
| Inventory | Generates Ansible inventory from VM IPs |

## Ansible

Configures Kubernetes on the provisioned VMs.

| Role | Target | Tasks |
|------|--------|-------|
| `common` | All nodes | Disable swap, install kubelet/kubeadm/kubectl, configure containerd, enable IP forwarding and bridge-nf-call |
| `control_plane` | Master | Initialize cluster, setup kubectl, install Flannel CNI, generate join command |
| `workers` | Workers | Copy join command from master, join the cluster |

## Usage

```bash
# SSH into control plane (key auto-generated by Terraform)
ssh -i infra/ansible/k8s_key.pem ubuntu@<control-plane-ip>
kubectl get nodes

# Horizon dashboard
http://<host-ip>/dashboard
# Login: admin / secret

# OpenStack CLI
source /opt/stack/devstack/openrc admin admin
openstack server list
```

## Cleanup

```bash
# Destroy K8s cluster
cd infra/terraform/k8s && terraform destroy

# Stop DevStack
cd /opt/stack/devstack && ./unstack.sh
```

## Architecture

```mermaid
flowchart TB
 subgraph Setup["Setup Script"]
    direction TB
        Start(["Start"])
        CreateUser["Create stack user"]
        SetPerms["Set permissions"]
        AddSudo["Add to sudoers"]
        CloneRepos["Clone repos"]
        CopyConfig["Copy local.conf"]
        RunStack["Run stack.sh"]
        Tests{"Tests pass?"}
        Deploy["Deploy Services"]
        Error(["Failed"])
  end
 subgraph UI["User Interface"]
    direction TB
        Horizon["Horizon - Dashboard"]
  end
 subgraph OpenStack["OpenStack Services"]
    direction TB
        Keystone["Keystone - Identity"]
        Nova["Nova - Compute"]
        Glance["Glance - Image"]
        Placement["Placement - Resource Tracking"]
  end
 subgraph Network["Neutron - Networking"]
    direction TB
        QSvc["q-svc - API Server"]
        QAgt["q-agt - OVS Agent"]
        QDhcp["q-dhcp - DHCP Agent"]
        QL3["q-l3 - L3 Agent"]
        QMeta["q-meta - Metadata Agent"]
  end
 subgraph Infra["Infrastructure"]
    direction TB
        MySQL[("MySQL")]
        RabbitMQ["RabbitMQ"]
  end
 subgraph Hypervisor["Virtualization"]
    direction TB
        Libvirt["Libvirt/KVM"]
        OVS["Open vSwitch"]
  end
    Start --> CreateUser
    CreateUser --> SetPerms
    SetPerms --> AddSudo
    AddSudo --> CloneRepos
    CloneRepos --> CopyConfig
    CopyConfig --> RunStack
    RunStack --> Tests
    Tests -- Yes --> Deploy
    Tests -- No --> Error
    Deploy -->|starts| Horizon
    Horizon -->|token auth| Keystone
    Horizon -->|manage instances| Nova
    Horizon -->|browse images| Glance
    Horizon -->|manage networks| QSvc
    Nova -->|validate tokens| Keystone
    Nova -->|RPC calls| RabbitMQ
    Nova -->|instance state| MySQL
    Nova -->|fetch images| Glance
    Nova -->|allocate CPU/RAM| Placement
    Nova -->|spawn VMs| Libvirt
    QSvc -->|network config| MySQL
    QSvc -->|agent RPC| RabbitMQ
    QAgt -->|bridge flows| OVS
    QL3 -->|NAT/routing| OVS
    Glance -->|image metadata| MySQL
    Placement -->|resource inventory| MySQL

    linkStyle 0 stroke:#FFFFFF
    linkStyle 1 stroke:#FFFFFF
    linkStyle 2 stroke:#FFFFFF
    linkStyle 3 stroke:#FFFFFF
    linkStyle 4 stroke:#FFFFFF
    linkStyle 5 stroke:#FFFFFF
    linkStyle 6 stroke:#FFFFFF
    linkStyle 7 stroke:#FFFFFF
    linkStyle 8 stroke:#FFFFFF
    linkStyle 9 stroke:#FFFFFF
    linkStyle 10 stroke:#FFFFFF
    linkStyle 11 stroke:#FFFFFF
    linkStyle 12 stroke:#FFFFFF
    linkStyle 13 stroke:#FFFFFF
    linkStyle 14 stroke:#FFFFFF
    linkStyle 15 stroke:#FFFFFF
    linkStyle 16 stroke:#FFFFFF
    linkStyle 17 stroke:#FFFFFF
    linkStyle 18 stroke:#FFFFFF
    linkStyle 19 stroke:#FFFFFF
    linkStyle 20 stroke:#FFFFFF
    linkStyle 21 stroke:#FFFFFF
    linkStyle 22 stroke:#FFFFFF
    linkStyle 23 stroke:#FFFFFF
    linkStyle 24 stroke:#FFFFFF
    linkStyle 25 stroke:#FFFFFF
```
